<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="medioqrity">



    <meta name="description" content="A mediocre student.">



<title>从零写一个编译器 - SA, IR与实际应用 | Medioqrity&#39;s Blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 4.2.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>
<body>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Medioqrity&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Medioqrity&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">从零写一个编译器 - SA, IR与实际应用</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">medioqrity</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2020/01/31&nbsp;&nbsp;23:26:14</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <h2 id="Review-Overview">Review &amp; Overview</h2>
<p>在前一篇<a href="https://medioqrity.github.io/2019/12/15/%E4%BB%8E%E9%9B%B6%E5%86%99%E4%B8%80%E4%B8%AA%E7%BC%96%E8%AF%91%E5%99%A8-Lexer%E4%B8%8EParser/">文章</a>中，我已经实现了Lexer, Parser，并且已经能够建立Parse Tree了。</p>
<p>接下来就是利用Semantic Analysis，也就是语义分析，创建Intermediate Representation，即中间表示。值得注意的是，可能会产生多种中间表示。</p>
<p>由于不同的应用所需要做的事情不尽相同，因此在简要说明SA和IR之后，就会进入实例部分，通过两个实际能够运行的简单应用来说明SA与IR是如何工作的。</p>
<h2 id="IR">IR</h2>
<p>我觉得抛开IR，上来就干讲语义分析，多少会让人有种*“我为啥要学这些”*的疑惑。即便已经事先知道SA是用来产生IR的，但是因为对IR的具体细节了解甚少，所以学的时候依然会感到十分困惑，没有目的性。</p>
<p>所以我在这里先简单说明一下一些简单且常见的IR。</p>
<h3 id="AST">AST</h3>
<p>全称Abstract Syntax Tree，语义树。</p>
<p>它和Parse Tree的最大区别就在于，<strong>AST略去了很多没必要的节点</strong>。</p>
<p>举个例子，考虑如下计算器文法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">START</span><br><span class="line">START -&gt; E</span><br><span class="line">E -&gt; E &quot;+&quot; T | E &quot;-&quot; T | T</span><br><span class="line">T -&gt; T &quot;*&quot; F | T &quot;&#x2F;&quot; F | F</span><br><span class="line">F -&gt; F &quot;**&quot; G | G</span><br><span class="line">G -&gt; &quot;(&quot; E &quot;)&quot; | &quot;int_const&quot;</span><br></pre></td></tr></table></figure>
<p>其中<code>**</code>代表幂。再考虑<code>((1 + 2) * 3) ** 4 - 5 ** 6</code>这样略复杂的输入串。</p>
<p>由于<code>()</code>和<code>**</code>都需要从<code>E</code>推导多次才能够到达，因此这个语法产生的Parse Tree相比之下非常臃肿:</p>
<p><img src="/2020/01/31/%E4%BB%8E%E9%9B%B6%E5%86%99%E4%B8%80%E4%B8%AA%E7%BC%96%E8%AF%91%E5%99%A8-SA,IR%E4%B8%8E%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8/PT.png" alt="AST"></p>
<p>相比之下，它的AST就很简单了:</p>
<p><img src="/2020/01/31/%E4%BB%8E%E9%9B%B6%E5%86%99%E4%B8%80%E4%B8%AA%E7%BC%96%E8%AF%91%E5%99%A8-SA,IR%E4%B8%8E%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8/AST_Tree.png" alt="AST_Tree"></p>
<h3 id="Control-Flow-Graph">Control-Flow Graph</h3>
<p>控制流图。似乎当初学校教C语言的时候有用这个来说明结构化程序。</p>
<p>来看看用java实现的二分搜索的例子:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] arr = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>&#125;;</span><br><span class="line">        <span class="keyword">int</span> l = <span class="number">0</span>, r = arr.length, key = <span class="number">5</span>;</span><br><span class="line">        <span class="keyword">while</span> (l &lt; r) &#123;</span><br><span class="line">            <span class="keyword">int</span> mid = l + ((r - l) &gt;&gt; <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (arr[mid] == key) <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (arr[mid] &lt; key) l = mid + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">else</span> r = mid;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">assert</span>(l == r);</span><br><span class="line">        System.out.println(arr[l] == key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应的控制流图如下:</p>
<p><img src="/2020/01/31/%E4%BB%8E%E9%9B%B6%E5%86%99%E4%B8%80%E4%B8%AA%E7%BC%96%E8%AF%91%E5%99%A8-SA,IR%E4%B8%8E%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8/ControlFlowGraph.png" alt="ControlFlowGraph"></p>
<h3 id="Three-Address-Code">Three-Address Code</h3>
<p>三地址代码。格式大致是<code>a = b op c</code>。</p>
<p>比方说对于:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">test</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (n - <span class="number">2</span>) * ((n - <span class="number">2</span>) * (n - <span class="number">2</span>) + <span class="number">6</span> * (n - <span class="number">2</span>) + <span class="number">11</span>) / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只关注<code>return</code>后的表达式的话，它的三地址代码应该是:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">t0 &#x3D; n - 2</span><br><span class="line">t1 &#x3D; n - 2</span><br><span class="line">t2 &#x3D; n - 2</span><br><span class="line">t3 &#x3D; t1 * t2</span><br><span class="line">t4 &#x3D; n - 2</span><br><span class="line">t5 &#x3D; 6 * t4</span><br><span class="line">t6 &#x3D; t3 + t5</span><br><span class="line">t7 &#x3D; t6 + 11</span><br><span class="line">t8 &#x3D; t0 * t7</span><br><span class="line">t9 &#x3D; t8 &#x2F; 3</span><br></pre></td></tr></table></figure>
<p>当然上面的写法只是为了好看，实际上是使用tuple来存储以上信息的:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(SUB, n, 2, t0)</span><br><span class="line">(SUB, n, 2, t1)</span><br><span class="line">(SUB, n, 2, t2)</span><br><span class="line">(MUL, t1, t2, t3)</span><br><span class="line">(SUB, n, 2, t4)</span><br><span class="line">(MUL, 6, t4, t5)</span><br><span class="line">(ADD, t3, t5, t6)</span><br><span class="line">(ADD, t6, 11, t7)</span><br><span class="line">(MUL, t0, t7, t8)</span><br><span class="line">(DIV, t8, 3, t9)</span><br></pre></td></tr></table></figure>
<h3 id="其他IR">其他IR</h3>
<p>包括但不限于:</p>
<ul>
<li>Dependence Graph</li>
<li>Call Graph</li>
<li>Single Static Assignment Form</li>
<li>Hybrid
<ul>
<li>Control-Flow Graph &amp; TAC Blocks</li>
</ul>
</li>
</ul>
<h2 id="Semantic-Analysis">Semantic Analysis</h2>
<p>语义分析。它出现的原因是，有时我们需要用到上下文相关的信息，而CFG产生的Parse Tree不能提供这些。</p>
<p>毕竟是<em>Context-Free</em> Grammar。</p>
<p>因此，我们需要在CFG的基础上，通过额外的信息，来使信息能够在上下文无关的Parse Tree的<strong>不同节点中传递</strong>，进而实现<strong>上下文相关</strong>的分析。</p>
<p>举一个非常常见的例子: <strong>类型系统</strong>。</p>
<p>在上下文无关文法中，仅凭Parse Tree是无法明确每个变量的类型的。因此，类似如下的代码可以通过Parser:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String a = <span class="string">"123"</span>;</span><br><span class="line"><span class="keyword">int</span> b = <span class="number">5</span> + a;</span><br></pre></td></tr></table></figure>
<p>但是怎么可能让一个<code>int</code>和<code>String</code>相加呢? 仅从逻辑上来看，就可以知道不会有任何有意义的结果。</p>
<p>所以，在对<code>5 + a</code>进行分析的时候，就要检查它们的类型相加之后是否合法。由于<code>a</code>的类型是上文定义的，因此是上下文相关的分析。</p>
<p>另外一个例子就是<strong>作用域</strong>。显然你不能跨域访问变量:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; ++i);</span><br><span class="line">System.out.println(i);</span><br></pre></td></tr></table></figure>
<p>上述代码显然是可以通过Parser的，但是确实是非法的代码。</p>
<p>那么要怎么在不同节点间传递数据呢? 语义分析又要怎么和IR联系起来呢?</p>
<h3 id="属性文法">属性文法</h3>
<p>简单来说，就是给Parse Tree的节点附加属性，并且给这些属性提供操作。通过预先定义的动作，我们可以建立AST，建立中间变量，生成TAC序列，生成Control-Flow Graph，建立符号表，建立作用域符号表等。</p>
<p>回到最简单的计算器的例子，我们可以给每个文法加上对应的动作，来计算答案:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">START</span><br><span class="line">START -&gt; STMT</span><br><span class="line">STMT -&gt; Assignment                 &#123; print(Assignment.val) &#125;</span><br><span class="line">      | E                          &#123; print(E.val) &#125;</span><br><span class="line">E -&gt; E &quot;+&quot; T                       &#123; E.val &#x3D; E1.val + T.val &#125;</span><br><span class="line">   | E &quot;-&quot; T                       &#123; E.val &#x3D; E1.val - T.val &#125;</span><br><span class="line">   | T                             &#123; E.val &#x3D; T.val&#125;</span><br><span class="line">T -&gt; T &quot;*&quot; F                       &#123; T.val &#x3D; T1.val * F.val &#125;</span><br><span class="line">   | T &quot;&#x2F;&quot; F                       &#123; T.val &#x3D; T1.val &#x2F; F.val &#125;</span><br><span class="line">   | F                             &#123; T.val &#x3D; F.val &#125;</span><br><span class="line">F -&gt; F &quot;**&quot; G                      &#123; F.val &#x3D; F1.val ** G.val &#125;</span><br><span class="line">   | G                             &#123; F.val &#x3D; G.val &#125;</span><br><span class="line">G -&gt; &quot;(&quot; E &quot;)&quot;                     &#123; G.val &#x3D; E.val &#125;</span><br><span class="line">   | &quot;int_const&quot;                   &#123; G.val &#x3D; int(int_const.lexString) &#125;</span><br><span class="line">   | &quot;id&quot;                          &#123; G.val &#x3D; d[id.lexString]&#125;</span><br><span class="line">Assignment -&gt; &quot;id&quot; &quot;&#x3D;&quot; &quot;int_const&quot; &#123; d[id.lexString] &#x3D; int(int_const.lexString) </span><br><span class="line">                                     Assignment.val &#x3D; d[id.lexString] &#125;</span><br></pre></td></tr></table></figure>
<p>这样就可以实现最简单的交互式计算器。</p>
<p>有的时候，文法需要在产生式中间使用，比方说:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Declaration -&gt; Type &#123; id.type &#x3D; Type.lexString &#125; &quot;id&quot;</span><br></pre></td></tr></table></figure>
<p>这种情况下，一般会需要根据前面已经计算出来的属性，去设置后面那些节点的属性。</p>
<p><em>如果去看教科书，可能还会看到利用依赖图和拓扑排序算出计算顺序的。不过目前在我的项目里还没看到。</em></p>
<h3 id="实现Parse-Tree">实现Parse Tree</h3>
<p>核心是正确地实现Parse Tree，确保它能够支持属性文法。同时，尽可能让编写动作变得简单易懂，可读性强。</p>
<p>为了能够在Parse Tree Node中设置必要的属性，而不用每次都通过<code>node[&quot;...&quot;]</code>这样的繁琐操作来对属性进行设置，需要实现<code>__setattr__</code>和<code>__getattr__</code>方法。</p>
<p>又考虑到AST可能也要用到基于属性文法的翻译，因此建立两个基类: <code>Tree</code>和<code>TreeNode</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TreeNode</span>:</span></span><br><span class="line"></span><br><span class="line">    SPLIT_LENGTH = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, content)</span>:</span></span><br><span class="line">        super().__setattr__(<span class="string">"__content"</span>, content)</span><br><span class="line">        super().__setattr__(<span class="string">"__d"</span>, &#123;&#125;)</span><br><span class="line">        super().__setattr__(<span class="string">"__childs"</span>, [])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        self.getAttributes()[key] = value</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.getAttributes()[key]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__contains__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> item <span class="keyword">in</span> self.getAttributes()</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> str(self.getContent())</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"'"</span> + str(self) + <span class="string">"'"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getAttributes</span><span class="params">(self)</span> -&gt; dict:</span></span><br><span class="line">        <span class="keyword">return</span> super().__getattribute__(<span class="string">"__d"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setAttribute</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        super().__setattr__(key, value)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getAttribute</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> super().__getattribute__(key)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">addChild</span><span class="params">(self, node)</span>:</span></span><br><span class="line">        <span class="keyword">assert</span> isinstance(node, TreeNode)</span><br><span class="line">        self.getChilds().append(node)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getChilds</span><span class="params">(self)</span> -&gt; list:</span></span><br><span class="line">        <span class="keyword">return</span> super().__getattribute__(<span class="string">"__childs"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getContent</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> super().__getattribute__(<span class="string">"__content"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">apply</span><span class="params">(self, func)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> child <span class="keyword">in</span> self.getChilds():</span><br><span class="line">            child.apply(func)</span><br><span class="line">        func(self, self.getChilds())</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">format</span><span class="params">(self)</span> -&gt; (list, int, int):</span></span><br><span class="line">        <span class="comment"># EMITTED...</span></span><br></pre></td></tr></table></figure>
<p>通过<code>__d</code>记录属性名值对的映射关系。</p>
<p><em>注: 这里，如果不用<code>super().__setattr__()</code>和<code>__getattribute__()</code>的话，会因为获取<code>self.__d</code>导致无限递归。</em></p>
<p>最后被省略的<code>def format(self)</code>是用来打印<strong>以当前节点为根节点的整棵树</strong>的方法。因为要使得输出美观，有非常多的变量需要控制，因此实在繁琐; 又因为与编译没有太大关系，倒更像是计算机图形学的内容，因而在此略去。<em>如果有兴趣请参阅Appendix A。</em></p>
<p>之后是<code>Tree</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tree</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, root)</span>:</span></span><br><span class="line">        <span class="keyword">assert</span> isinstance(root, TreeNode)</span><br><span class="line">        self.__root = root</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        c, _, _, _ = self.__root.format()</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'\n'</span>.join(c)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getRoot</span><span class="params">(self)</span> -&gt; TreeNode:</span></span><br><span class="line">        <span class="keyword">return</span> self.__root</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">apply</span><span class="params">(self, func)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        apply @param func on every TreeNode</span></span><br><span class="line"><span class="string">        the format of func param should be:</span></span><br><span class="line"><span class="string">        func(parent, childs)</span></span><br><span class="line"><span class="string">        parent is a TreeNode, Childs is a list containing many TreeNodes</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.getRoot().apply(func)</span><br></pre></td></tr></table></figure>
<p>简单地记录了一下根节点。</p>
<p>接下来是<code>PTNode</code>，即Parse Tree Node:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> core.myToken <span class="keyword">import</span> Token</span><br><span class="line"><span class="keyword">from</span> core.Types <span class="keyword">import</span> Types</span><br><span class="line"><span class="keyword">from</span> core.tree <span class="keyword">import</span> TreeNode, Tree</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PTNode</span><span class="params">(TreeNode)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, content, isTerminal=False, terminalType=None, grammarID=<span class="number">-1</span>)</span>:</span></span><br><span class="line">        <span class="comment"># content may be either Token or Str</span></span><br><span class="line">        super().__init__(content)</span><br><span class="line">        super().setAttribute(<span class="string">"__grammarID"</span>, grammarID)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getGrammarID</span><span class="params">(self)</span> -&gt; int:</span></span><br><span class="line">        <span class="keyword">return</span> super().getAttribute(<span class="string">"__grammarID"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(other, str):</span><br><span class="line">            <span class="keyword">return</span> self.getContent() == other</span><br><span class="line">        <span class="keyword">elif</span> isinstance(other, PTNode):</span><br><span class="line">            <span class="keyword">return</span> self.getContent() == other.getContent()</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.getAttributes()[key]</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        self.getAttributes()[key] = value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reverse</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.getChilds().reverse()</span><br></pre></td></tr></table></figure>
<p>额外记录了grammar ID，也就是在说明当前节点和它的子节点对应着哪个产生式。</p>
<p>然后是用于将函数注册到对应产生式上的<code>ParseTreeActionRegister</code>类:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParseTreeActionRegister</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, cfg)</span>:</span></span><br><span class="line">        self.__productionToAction = &#123;&#125;</span><br><span class="line">        self.__cfg = cfg</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">production</span><span class="params">(self, *productions, index=<span class="number">-1</span>)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        register a function to run at some position in the production</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        @tree.production('E -&gt; E "+" T')</span></span><br><span class="line"><span class="string">        def foo(e, e1, plus, t):</span></span><br><span class="line"><span class="string">            return "bar"</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">decorate</span><span class="params">(function)</span>:</span></span><br><span class="line">            <span class="keyword">for</span> prod <span class="keyword">in</span> productions:</span><br><span class="line">                self.__productionToAction.\</span><br><span class="line">                    setdefault(self.__cfg.getIDByRawGrammar(prod), &#123;&#125;)\</span><br><span class="line">                        [index] = function</span><br><span class="line">            <span class="keyword">return</span> function</span><br><span class="line">        <span class="keyword">return</span> decorate</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getProductionMapping</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.__productionToAction</span><br></pre></td></tr></table></figure>
<p>我将<code>production</code>方法写成了装饰器。这样，就不用做出类似于<em>定义一大堆函数然后再用一个手动维护的字典来说明函数和产生式的对应情况</em>这种维护起来非常麻烦的事情了。</p>
<p>光有注册的工具还不够，需要明确<code>ParseTree</code>内部是怎么使用<code>ActionRegister</code>提供的函数的，才能够写出正确的动作:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParseTree</span><span class="params">(Tree)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, root)</span>:</span></span><br><span class="line">        super().__init__(root)</span><br><span class="line">        self.__ar = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setActionRegister</span><span class="params">(self, actionRegister)</span>:</span></span><br><span class="line">        self.__ar = actionRegister</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">evaluate</span><span class="params">(self, ar=None, currentNode=None)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        evaluate the attributes according to the rules registered in ActionRegister</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> ar <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">assert</span> self.__ar <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line">            ar = self.__ar</span><br><span class="line">        productionToAction = ar.getProductionMapping()</span><br><span class="line">        <span class="keyword">if</span> currentNode <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            currentNode = self.getRoot()</span><br><span class="line">        grammarID = currentNode.getGrammarID()</span><br><span class="line">        <span class="keyword">for</span> i, child <span class="keyword">in</span> enumerate(currentNode.getChilds()):</span><br><span class="line">            <span class="keyword">if</span> grammarID != <span class="number">-1</span> <span class="keyword">and</span> i <span class="keyword">in</span> productionToAction[grammarID]:</span><br><span class="line">                productionToAction[grammarID][i](currentNode, *currentNode.getChilds())</span><br><span class="line">            self.evaluate(ar=ar, currentNode=child)</span><br><span class="line">        <span class="keyword">if</span> grammarID != <span class="number">-1</span> <span class="keyword">and</span> <span class="number">-1</span> <span class="keyword">in</span> productionToAction[grammarID]:</span><br><span class="line">            productionToAction[grammarID][<span class="number">-1</span>](currentNode, *currentNode.getChilds())</span><br></pre></td></tr></table></figure>
<p>通过<code>evaluate(ar=register)</code>方法，就可以对整棵树应用预先定义好的规则了。</p>
<p>由于<code>productionToAction[grammarID][i]</code>的返回值是一个函数，不妨记为<code>func</code>，那么调用方式就是<code>func(currentNode, *currentNode.getChilds())</code>。后面一个参数使用了<em>自动解包</em>，这么做的好处很快就能看到。</p>
<h2 id="带变量存储功能的简易表达式计算器">带变量存储功能的简易表达式计算器</h2>
<p>在写完Parse Tree之后，就可以来实现一个简单的计算器了。</p>
<p>在一切开始之前，首先书写CFG:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">START</span><br><span class="line">START -&gt; Statement</span><br><span class="line">Statement -&gt; Assignment | E</span><br><span class="line">E -&gt; E &quot;+&quot; T | E &quot;-&quot; T | T</span><br><span class="line">T -&gt; T &quot;*&quot; F | T &quot;&#x2F;&quot; F | T &quot;%&quot; F | F</span><br><span class="line">F -&gt; F &quot;^&quot; G | G</span><br><span class="line">G -&gt; &quot;(&quot; E &quot;)&quot; | &quot;int_const&quot; | &quot;id&quot;</span><br><span class="line">Assignment -&gt; &quot;id&quot; &quot;&#x3D;&quot; E</span><br></pre></td></tr></table></figure>
<p>接下来就可以开始写代码了。第一步，建立CFG、生成该CFG对应的Action &amp; Goto表、并声明Action Register:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cfg = CFG.createCFGByFileName(<span class="string">"CFGs/CFG4"</span>)</span><br><span class="line">action, goto = myParser.generateActionAndGoto(cfg)</span><br><span class="line">ar = ActionRegister(cfg)</span><br></pre></td></tr></table></figure>
<p>由于要存储变量，因此设定一个字典:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">global</span> d</span><br><span class="line">d = &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>然后注册对应的动作:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ar.production('Statement -&gt; E', 'Statement -&gt; Assignment')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__stmt</span><span class="params">(stmt, _)</span>:</span></span><br><span class="line">    print(_.val)</span><br><span class="line"></span><br><span class="line"><span class="meta">@ar.production('E -&gt; E "+" T')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__e0</span><span class="params">(e, e1, _, t)</span>:</span></span><br><span class="line">    e.val = e1.val + t.val</span><br><span class="line"></span><br><span class="line"><span class="meta">@ar.production('E -&gt; E "-" T')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__e1</span><span class="params">(e, e1, _, t)</span>:</span></span><br><span class="line">    e.val = e1.val - t.val</span><br><span class="line"></span><br><span class="line"><span class="meta">@ar.production('E -&gt; T')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__e2</span><span class="params">(e, t)</span>:</span></span><br><span class="line">    e.val = t.val</span><br><span class="line"></span><br><span class="line"><span class="meta">@ar.production('T -&gt; T "*" F')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__t0</span><span class="params">(t, t1, _, f)</span>:</span></span><br><span class="line">    t.val = t1.val * f.val</span><br><span class="line"></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@ar.production('G -&gt; "int_const"')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__g1</span><span class="params">(g, int_const)</span>:</span></span><br><span class="line">    g.val = int(int_const.getContent())</span><br><span class="line"></span><br><span class="line"><span class="meta">@ar.production('G -&gt; "id"')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__g2</span><span class="params">(g, id_)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> d</span><br><span class="line">    g.val = d[id_.getContent()]</span><br><span class="line"></span><br><span class="line"><span class="meta">@ar.production('Assignment -&gt; "id" "=" E')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__assign</span><span class="params">(assi, id_, _, E)</span>:</span></span><br><span class="line">    d[id_.getContent()] = E.val</span><br><span class="line">    assi.val = d[id_.getContent()]</span><br></pre></td></tr></table></figure>
<p>通过<em>自动解包</em>，直接将子节点作为参数传进来，省去了<code>t1, _, f = t.getChilds()</code>这类的臃肿且重复的语句，写起来确实很方便。</p>
<p>最后写一个<code>while</code>循环就可以实现读入，建树并求值的过程了:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        inputString = input(<span class="string">"&gt;&gt;&gt; "</span>)</span><br><span class="line">        tokenList = lexer.parse(inputString)</span><br><span class="line">        pt = myParser.parse(cfg, tokenList, action, goto)</span><br><span class="line">        pt.evaluate(ar)</span><br><span class="line">    <span class="keyword">except</span> EOFError:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>来看看实际的结果:</p>
<p><img src="/2020/01/31/%E4%BB%8E%E9%9B%B6%E5%86%99%E4%B8%80%E4%B8%AA%E7%BC%96%E8%AF%91%E5%99%A8-SA,IR%E4%B8%8E%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8/calc.png" alt="calc"></p>
<p>这个项目中，只涉及到了翻译。不过，只需稍微改变一点文法，就可以将它与AST结合起来，生成三地址代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ar.production('E -&gt; E "+" T')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__e0</span><span class="params">(e, e1, _, t)</span>:</span></span><br><span class="line">    e.node = ASTNode(<span class="string">"ADD"</span>, e1.node, t.node)</span><br><span class="line"></span><br><span class="line"><span class="meta">@ar.production('E -&gt; E "-" T')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__e1</span><span class="params">(e, e1, _, t)</span>:</span></span><br><span class="line">    e.node = ASTNode(<span class="string">"SUB"</span>, e1.node, t.node)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ...</span></span><br></pre></td></tr></table></figure>
<p>建立ASTNode后，声明一个用于生成三地址代码的函数:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dfs</span><span class="params">(cur, childs)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> count</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> childs:</span><br><span class="line">        cur.varName = cur.getContent()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        cur.varName = <span class="string">"t%d"</span> % count</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        l, r = childs</span><br><span class="line">        print(<span class="string">"%s %s %s %s"</span> % (cur.getContent(), l.varName, r.varName, cur.varName))</span><br></pre></td></tr></table></figure>
<p>最后，稍微修改一下<code>while</code>主循环部分，建AST并应用该函数即可:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        inputString = input(<span class="string">"&gt;&gt;&gt; "</span>)</span><br><span class="line">        tokenList = lexer.parse(inputString)</span><br><span class="line">        pt = myParser.parse(cfg, tokenList, action, goto)</span><br><span class="line">        pt.evaluate(ar)</span><br><span class="line">        ast = AbstractSyntaxTree(pt.getRoot().node)</span><br><span class="line">        print(ast)</span><br><span class="line">        ast.apply(dfs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> EOFError:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>得到的结果大致如下:</p>
<p><img src="/2020/01/31/%E4%BB%8E%E9%9B%B6%E5%86%99%E4%B8%80%E4%B8%AA%E7%BC%96%E8%AF%91%E5%99%A8-SA,IR%E4%B8%8E%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8/calc_AST.png" alt="calc_AST"></p>
<h2 id="简易数据库查询引擎">简易数据库查询引擎</h2>
<p>CCSP 2019的那道<a href="https://medioqrity.github.io/2019/10/17/CCSP-2019%E6%B8%B8%E8%AE%B0/#SQL-Query">SQL查询</a>一直是我心心念念想要补的题。</p>
<p>我想，也许现在我终于有战胜它的能力了。</p>
<h3 id="原题题干">原题题干</h3>
<p>顿顿想要建立一个简单的教务管理数据库，用于存储学生的考试成绩并支持一些基本的查询操作。</p>
<h4 id="数据格式">数据格式</h4>
<p>该数据库包含以下五张<strong>数据表</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Student(sid, dept, age)</span><br></pre></td></tr></table></figure>
<p>学生信息表：<code>sid</code> 为主键，表示学生 ID；<code>dept</code> 表示学生所在院系名称；<code>age</code> 表示学生的年龄。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Course(cid, name)</span><br></pre></td></tr></table></figure>
<p>课程信息表：<code>cid</code> 为主键，表示课程 ID；<code>name</code> 表示课程名称。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Teacher(tid, dept, age)</span><br></pre></td></tr></table></figure>
<p>教师信息表：<code>tid</code> 为主键，表示教师 ID；<code>dept</code> 表示教师所在院系名称；<code>age</code> 表示教师的年龄。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Grade(sid, cid, score)</span><br></pre></td></tr></table></figure>
<p>成绩信息表：<code>sid</code> 和 <code>cid</code> 分别来自 <code>Student</code> 表和 <code>Course</code> 表的主键（即每条<strong>记录</strong>中的 <code>sid</code> 和 <code>cid</code> 一定存在于相应的<strong>表</strong>中，下同），二者一起作为该表的主键；<code>score</code> 表示该学生这门课程的成绩。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Teach(cid, tid)</span><br></pre></td></tr></table></figure>
<p>授课信息表：<code>cid</code> 和 <code>tid</code> 分别来自 <code>Course</code> 表和 <code>Teacher</code> 表的主键，二者一起作为该表的主键；需要注意的是，一门课程可以有多个老师授课。</p>
<p>注：**主键（Primary Key）**可以唯一标识表中的每条记录，换言之在一张表中所有记录的主键互不相同。</p>
<p>在上述表中，<code>age</code> 和 <code>score</code> 是 $[0,100]$ 的整数，其余都是长度小于等于 $10$ 的非空字符串。其中三个主键 <code>sid</code>、<code>cid</code> 和 <code>tid</code> 由数字 <code>0...9</code> 组成，而 <code>name</code> 和 <code>dept</code> 则由大小写字母组成。</p>
<h4 id="查询语句">查询语句</h4>
<p>该数据库支持使用一种简单的 <code>SELECT</code> 语句进行查询，文法定义如下所述。最终所有的查询语句都可以由 <code>QUERY</code> 符号推导而来。</p>
<p>在所有定义中，<code>::=</code> 表示其左侧的符号可以推导为右侧的符号串，其中带单引号的符号表示此符号为固定的字符串，不带引号的则表示符号还需要进行进一步推导。<code>[]</code> 表示文法中的可选内容。如果一个符号存在多种推导方式 <code>A ::= B</code> 和 <code>A ::= C</code>，则可以简写为 <code>A ::= B | C</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">QUERY ::&#x3D; &#39;SELECT&#39; &#39;*&#39; &#39;FROM&#39; TABLES [&#39;WHERE&#39; EXPR]</span><br><span class="line">QUERY ::&#x3D; &#39;SELECT&#39; COLUMNS &#39;FROM&#39; TABLES [&#39;WHERE&#39; EXPR]</span><br></pre></td></tr></table></figure>
<p>从指定的<strong>表</strong>（<code>TABLES</code>）中查询满足<strong>筛选条件</strong>（<code>EXPR</code>）的<strong>记录</strong>，并按照指定的<strong>列</strong>（<code>COLUMNS</code>）输出。如果没有给出<strong>筛选条件</strong>，则返回所有的<strong>记录</strong>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TABLES ::&#x3D; TABLE_NAME | TABLE_NAME &#39;,&#39; TABLE_NAME</span><br><span class="line">TABLE_NAME ::&#x3D; &#39;Student&#39; | &#39;Grade&#39; | &#39;Course&#39; | &#39;Teach&#39; | &#39;Teacher&#39;</span><br></pre></td></tr></table></figure>
<p><code>TABLES</code> 可以包含多张<strong>表</strong>，此时新表中的<strong>列</strong>是这些表中列的笛卡尔积，一个例子如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+---------+ +---------+ +------------+ +------------+</span><br><span class="line">| Table A | | Table B | | Table A, B | | Table B, A |</span><br><span class="line">+---------+ +---------+ +------------+ +------------+</span><br><span class="line">| a1      | | b1      | | a1, b1     | | b1, a1     |</span><br><span class="line">| a2      | | b2      | | a1, b2     | | b1, a2     |</span><br><span class="line">+---------+ | b3      | | a1, b3     | | b2, a1     |</span><br><span class="line">            +---------+ | a2, b1     | | b2, a2     |</span><br><span class="line">                        | a2, b2     | | b3, a1     |</span><br><span class="line">                        | a2, b3     | | b3, a2     |</span><br><span class="line">                        +------------+ +------------+</span><br></pre></td></tr></table></figure>
<p>本题中约定 <code>TABLES</code> <strong>仅会包含一张或两张不同的表</strong>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">COLUMNS ::&#x3D; COLUMN | COLUMNS &#39;,&#39; COLUMN</span><br><span class="line">COLUMN ::&#x3D; [TABLE_NAME &#39;.&#39;] COLUMN_NAME</span><br><span class="line">COLUMN_NAME ::&#x3D; &#39;sid&#39; | &#39;cid&#39; | &#39;tid&#39; | &#39;age&#39; | &#39;score&#39; | &#39;dept&#39; | &#39;name&#39;</span><br></pre></td></tr></table></figure>
<p><code>COLUMNS</code> 也是递归定义，即由逗号分隔的至少一个 <code>COLUMN</code> 组成。在无歧义时（即 <code>TABLES</code> 中只有<strong>唯一的表</strong>含有该<strong>列</strong>），<code>COLUMN</code> 中的 <code>TABLE_NAME</code> 是可选的。<code>SELECT age FROM Student, Teacher</code> 是一种典型的歧义句式，因为无法确定其中想要选取的 <code>age</code> 是学生还是教师的年龄。</p>
<p>虽然在文法上一个 <code>COLUMN</code> 可以由任意 <code>TABLE_NAME</code> 和 <code>COLUMN_NAME</code> 组合而成，但在实际处理时，这两者需要符合上面定义的表结构。比如 <code>Course.sid</code> 就是一种错误的写法，因为 <code>Course</code> 表中并没有 <code>sid</code> 这一列。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EXPR ::&#x3D; COND | EXPR &#39;AND&#39; COND</span><br><span class="line">COND ::&#x3D; COLUMN CMP CONSTANT | COLUMN &#39;&#x3D;&#39; COLUMN</span><br><span class="line">CMP ::&#x3D; &#39;&gt;&#39; | &#39;&#x3D;&#39; | &#39;&lt;&#39;</span><br></pre></td></tr></table></figure>
<p>其中：</p>
<ul>
<li><code>EXPR</code> 是一个合取布尔表达式，由若干个<strong>比较条件</strong>（<code>COND</code>）用 <code>AND</code> 连接而成，表示<strong>筛选条件</strong>（即满足该条件的<strong>记录</strong>才会被输出）。</li>
<li><code>CONSTANT</code> 没有文法定义，它表示一个<strong>常量</strong>，且其类型和数据范围与相比较的 <code>COLUMN</code> 一致；如果是字符串类型，还需用双引号括起（例如 <code>&quot;Sam&quot;</code>）。</li>
</ul>
<p>这里我们额外规定：</p>
<ul>
<li><strong>列</strong>与<strong>常量</strong>进行比较时（<code>COLUMN CMP CONSTANT</code>），整数类型（<code>age</code>、<code>score</code>）可以进行大于、小于和等于三种判断，字符串类型只能做等于判断；</li>
<li>两<strong>列</strong>进行比较时（<code>COLUMN = COLUMN</code>），它们需来自不同的<strong>表</strong>且二者的<strong>列名</strong>（<code>COLUMN_NAME</code>）必须相同；</li>
<li>在一个 <code>EXPR</code> 中，<code>COLUMN CMP CONSTANT</code> 类型的 <code>COND</code> 个数不限，但 <code>COLUMN = COLUMN</code> 最多只能出现一次。</li>
</ul>
<p>查询语句大小写敏感，全部的<strong>保留字</strong>包括：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT, *, FROM, WHERE, AND, Student, Course, Teacher, Grade, Teach</span><br><span class="line">sid, cid, tid, dept, name, age, score</span><br></pre></td></tr></table></figure>
<p>全部的<strong>分隔符</strong>包括：<code>,</code>, <code>.</code>, <code>&gt;</code>, <code>=</code>, <code>&lt;</code>, <code> </code>（空格）。</p>
<p>双引号（<code>&quot;</code>）应视作字符串<strong>常量</strong>的一部分而非<strong>保留字</strong>或<strong>分隔符</strong>。</p>
<p>每个<strong>保留字</strong>和<strong>常量</strong>（<code>CONSTANT</code>）可视作查询语句中的一个<strong>基本单位</strong>，在格式上我们约定：</p>
<ul>
<li>每条查询语句占一行；</li>
<li><strong>基本单位</strong>不可分割；</li>
<li>为避免歧义，两个<strong>基本单位</strong>之间应至少有一个<strong>分隔符</strong>，并且允许存在任意多的空格；</li>
<li>一行总长度不超过 $100$ 个字符。</li>
</ul>
<h4 id="结果输出">结果输出</h4>
<p>对每条查询输出一张<strong>表</strong>，<strong>列</strong>由 <code>COLUMNS</code> 指定，每行为一条满足<strong>筛选条件</strong>（<code>EXPR</code>）的<strong>记录</strong>（不同的<strong>列</strong>间用一个空格分隔）。这里只需要输出所有满足条件的<strong>记录</strong>，不需要打印表头；查询结果为空则不输出；<strong>字符串类型无需输出双引号</strong>。若想输出所有的<strong>列</strong>，可以用 <code>*</code> 代替 <code>COLUMNS</code>；若 <code>TABLES</code> 中只有一张<strong>表</strong>，此时应输出该<strong>表</strong>的全部<strong>列</strong>；如果有第二张<strong>表</strong>，应输出第一张<strong>表</strong>的全部<strong>列</strong>与二张<strong>表</strong>的全部<strong>列</strong>的笛卡尔积；表内部的<strong>列</strong>按照上文定义时给出的顺序排序。</p>
<p>如果 <code>TABLES</code> 仅含一张<strong>表</strong>，则按该<strong>表</strong>的顺序依次输出符合条件的<strong>记录</strong>。若 <code>TABLES</code> 包含两张<strong>表</strong>（形如 <code>A,B</code>），则先考虑 A 的顺序，再考虑 B 的顺序（参考前文中两张表做笛卡尔积的例子）。</p>
<h3 id="CFG">CFG</h3>
<p>题干中给出了很明确的CFG。照抄就可以用了:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Start</span><br><span class="line">Start -&gt; Query</span><br><span class="line">Query -&gt; &quot;SELECT&quot; Columns &quot;FROM&quot; Tables | &quot;SELECT&quot; Columns &quot;FROM&quot; Tables &quot;WHERE&quot; Expr</span><br><span class="line">Tables -&gt; Tables &quot;,&quot; TableName | TableName</span><br><span class="line">TableName -&gt; &quot;id&quot;</span><br><span class="line">Columns -&gt; Columns &quot;,&quot; Column | &quot;*&quot; | Column</span><br><span class="line">Column -&gt; ColumnName | TableName &quot;.&quot; ColumnName</span><br><span class="line">ColumnName -&gt; &quot;id&quot;</span><br><span class="line">Expr -&gt; Expr &quot;AND&quot; Cond | Cond</span><br><span class="line">Cond -&gt; Column CMP Constant | Column &quot;&#x3D;&quot; Column</span><br><span class="line">CMP -&gt; &quot;&lt;&quot; | &quot;&#x3D;&quot; | &quot;&gt;&quot;</span><br><span class="line">Constant -&gt; &quot;int_const&quot; | &quot;str_literal&quot;</span><br></pre></td></tr></table></figure>
<h3 id="数据库基本类及其简略实现">数据库基本类及其简略实现</h3>
<ul>
<li>
<p><code>class Row</code></p>
<p>广义上的一条记录。里面放的是一个列表。它并不存储每一列的信息。否则会导致大量重复的内存开销。</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Row</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Basic Row object</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, data=None)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> data <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            data = []</span><br><span class="line">        <span class="keyword">assert</span> isinstance(data, list)</span><br><span class="line">        self.__data = list(data)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>class Column</code></p>
<p>定义一列数据。包含TableName和ColumnName。</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Column</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, tableName, columnName)</span>:</span></span><br><span class="line">        self.__tn = tableName</span><br><span class="line">        self.__cn = columnName</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>class Table</code></p>
<p>表。</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Table</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Table, containing a list of Row objects, and the definition of every column</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, columnDef, rows=None)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        columnDef is the definition of columns, including a list of Column objects.</span></span><br><span class="line"><span class="string">        The reason for table name is because a temporary merged table may contain columns</span></span><br><span class="line"><span class="string">        from other tables.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">assert</span> isinstance(name, str)</span><br><span class="line">        self.__name = name</span><br><span class="line">        <span class="keyword">assert</span> isinstance(columnDef, tuple)</span><br><span class="line">        self.__cd = columnDef</span><br><span class="line">        self.__c2i = &#123;&#125;  <span class="comment"># column to integer</span></span><br><span class="line">        <span class="keyword">for</span> i, col <span class="keyword">in</span> enumerate(columnDef):</span><br><span class="line">            self.__c2i[col] = i</span><br><span class="line">            <span class="keyword">if</span> col.getTableName() <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                halfCol = Column(<span class="literal">None</span>, col.getColumnName())</span><br><span class="line">                self.__c2i[halfCol] = i  <span class="comment"># for Column(None, ...)</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                fullCol = Column(self.__name, col.getColumnName())</span><br><span class="line">                self.__c2i[fullCol] = i</span><br><span class="line">        <span class="comment"># print(self.__c2i)</span></span><br><span class="line">        <span class="keyword">if</span> rows <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            rows = []</span><br><span class="line">        <span class="keyword">assert</span> isinstance(rows, list)</span><br><span class="line">        self.__r = rows</span><br></pre></td></tr></table></figure>
<p>由于列的定义都是放在Table内的，因此要获取Row内的对应数据还需要先从table内获取index才行。为了快速获取index，设置了字典<code>self.__c2i</code>。</p>
</li>
<li>
<p><code>class AtomCond</code></p>
<p>一个原子条件，只有一个操作符和两个操作数。</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AtomCond</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, operator, lOperand, rOperand)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        operands must be Column object or constant</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">assert</span> isinstance(operator, Operators)</span><br><span class="line">        self.__operator = operator</span><br><span class="line">        self.__lop = lOperand</span><br><span class="line">        self.__rop = rOperand</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check</span><span class="params">(self, row, table)</span>:</span></span><br><span class="line">        val1 = row[table.getColumnIndex(self.__lop)] <span class="keyword">if</span> isinstance(self.__lop, Column) <span class="keyword">else</span> self.__lop</span><br><span class="line">        val2 = row[table.getColumnIndex(self.__rop)] <span class="keyword">if</span> isinstance(self.__rop, Column) <span class="keyword">else</span> self.__rop</span><br><span class="line">        <span class="keyword">return</span> self.__operator.value[<span class="number">1</span>](val1, val2)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">isApplicable</span><span class="params">(self, table)</span> -&gt; bool:</span></span><br><span class="line">        <span class="comment"># return true if all OP in this Cond object is in the table column def</span></span><br><span class="line">        <span class="keyword">for</span> op <span class="keyword">in</span> [self.__lop, self.__rop]:</span><br><span class="line">            <span class="keyword">if</span> isinstance(op, Column):</span><br><span class="line">                <span class="keyword">if</span> table.getColumnIndex(op) <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">                <span class="keyword">elif</span> table.getColumnIndex(op) &gt;= len(table.getColumnDef()):</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<p>额外提供了两个函数。<code>check</code>是用于确定这一行是否符合条件的。</p>
<p>对于两表合并的情况来说，<code>row</code>是两个记录产生的新纪录。因此才不是<code>check(self, row1, row2)</code>这种写法。</p>
<p><code>isApplicable(table)</code>函数确定该条件是否适用于<code>table</code>。由于在对分析树进行翻译时，我们是无法得知<code>cond</code>的每个operand是否都隶属于当前表的。因此只能运行时检查了。</p>
</li>
<li>
<p><code>def mergeWithNoCond(table1, table2) -&gt; table</code></p>
<p>无条件合并两张表，返回一张新表。</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mergeWithNoCond</span><span class="params">(newTableName, table1, table2)</span>:</span></span><br><span class="line">    newColDef, needToAdd = mergeColDef(table1.getColumnDef(), table2.getColumnDef())</span><br><span class="line">    resultTable = Table(newTableName, newColDef)</span><br><span class="line">    <span class="keyword">for</span> r1 <span class="keyword">in</span> table1.getRows():</span><br><span class="line">        <span class="keyword">for</span> r2 <span class="keyword">in</span> table2.getRows():</span><br><span class="line">            resultTable.addRow(mergeRows(r1, r2, needToAdd))</span><br><span class="line">    <span class="keyword">return</span> resultTable</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>def mergeWithCond(table1, table2, atom_cond) -&gt; table</code></p>
<p>根据<code>atom_cond</code>合并两张表，返回一张新表。可以在这里利用hash table将时间复杂度从$\mathcal{O}(n \cdot m)$降到$\mathcal{O}(n + m)$。</p>
<p>这里的<code>atom_cond</code>就是最基础的条件，也就是只包含一个Operator和两个Operand的条件。</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mergeWithCond</span><span class="params">(newTableName, table1, table2, cond)</span>:</span></span><br><span class="line">    newColDef, needToAdd = mergeColDef(table1.getColumnDef(), table2.getColumnDef())</span><br><span class="line">    resultTable = Table(newTableName, newColDef)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># check whether this condition can be applied or not</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cond.isApplicable(resultTable):</span><br><span class="line">        <span class="keyword">return</span> table1  <span class="comment"># thus nothing would change</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># so table 1 is completely the same as the table 2, just apply filter</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> any(needToAdd):</span><br><span class="line">        <span class="keyword">return</span> applyFilterCond(newTableName, table1, cond)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> cond.canUseHashAcc():</span><br><span class="line">        hashTable = &#123;&#125;</span><br><span class="line">        col1 = cond.getRelatedOperand(table1)</span><br><span class="line">        col2 = cond.getRelatedOperand(table2)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> col1 <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> col2 <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> table1</span><br><span class="line"></span><br><span class="line">        <span class="comment"># hash</span></span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> table2.getRows():</span><br><span class="line">            val = row[table2.getColumnIndex(col2)]</span><br><span class="line">            hashTable.setdefault(val, []).append(row)  <span class="comment"># hope the val is hashable</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># quick merge</span></span><br><span class="line">        <span class="keyword">for</span> row1 <span class="keyword">in</span> table1.getRows():</span><br><span class="line">            val = row1[table1.getColumnIndex(col1)]</span><br><span class="line">            <span class="keyword">if</span> val <span class="keyword">in</span> hashTable:</span><br><span class="line">                <span class="keyword">for</span> row2 <span class="keyword">in</span> hashTable[val]:  <span class="comment"># eq</span></span><br><span class="line">                    resultTable.addRow(mergeRows(row1, row2, needToAdd))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> r1 <span class="keyword">in</span> table1.getRows():</span><br><span class="line">            <span class="keyword">for</span> r2 <span class="keyword">in</span> table2.getRows():</span><br><span class="line">                r = mergeRows(r1, r2, needToAdd)</span><br><span class="line">                <span class="keyword">if</span> cond.check(r, resultTable):</span><br><span class="line">                    resultTable.addRow(r)</span><br><span class="line">    <span class="keyword">return</span> resultTable</span><br></pre></td></tr></table></figure>
<p>分类讨论，如果条件可以使用哈希表加速，就加速。否则合并生成每个可能的新记录，然后通过<code>cond.check()</code>确定是否符合条件。</p>
</li>
<li>
<p><code>def mergeRow(row1, row2, needToAdd) -&gt; row</code></p>
<p>合并两条记录。</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mergeRows</span><span class="params">(row1, row2, needToAdd)</span> -&gt; Row:</span></span><br><span class="line">    result = list(row1.getData())</span><br><span class="line">    <span class="keyword">for</span> i, _ <span class="keyword">in</span> enumerate(row2.getData()):</span><br><span class="line">        <span class="keyword">if</span> needToAdd[i]:</span><br><span class="line">            result.append(_)</span><br><span class="line">    <span class="keyword">return</span> Row(result)</span><br></pre></td></tr></table></figure>
<p>由于table1和table2可能存在一些Column是重复的，因此需要一个额外的bool list，记载row2每个index是否需要加入新记录中。</p>
</li>
<li>
<p><code>def selectColumn(table, *columns) -&gt; table</code></p>
<p>从table中选择一些列，返回一个新的table。</p>
</li>
<li>
<p><code>def applyFilterCond(newTableName, table, cond)</code></p>
<p>对整个表按<code>cond</code>进行筛选，返回一个新的表。</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">applyFilterCond</span><span class="params">(newTableName, table, cond)</span>:</span></span><br><span class="line">    resultTable = Table(newTableName, table.getColumnDef())</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cond.isApplicable(resultTable):</span><br><span class="line">        <span class="keyword">return</span> table  <span class="comment"># thus nothing would change</span></span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> table.getRows():</span><br><span class="line">        <span class="keyword">if</span> cond.check(row, resultTable):</span><br><span class="line">            resultTable.addRow(row)</span><br><span class="line">    <span class="keyword">return</span> resultTable</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>通过这些函数，应该可以<strong>翻译出一段python代码</strong>，用于执行基于python的数据库库类的查询。比方说考虑如下查询语句:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Student.sid, Course.name, score</span><br><span class="line"><span class="keyword">FROM</span> Student, Grade, Course</span><br><span class="line"><span class="keyword">WHERE</span> Student.sid = Grade.sid <span class="keyword">AND</span> Course.cid = Grade.cid</span><br></pre></td></tr></table></figure>
<p>应该可以翻译成:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">col0 = Column(<span class="string">'Student'</span>, <span class="string">'sid'</span>)</span><br><span class="line">col1 = Column(<span class="string">'Course'</span>, <span class="string">'name'</span>)</span><br><span class="line">col2 = Column(<span class="literal">None</span>, <span class="string">'score'</span>)</span><br><span class="line">col3 = Column(<span class="string">'Student'</span>, <span class="string">'sid'</span>)</span><br><span class="line">col4 = Column(<span class="string">'Grade'</span>, <span class="string">'sid'</span>)</span><br><span class="line">con0 = AtomCond(Operators.EQ, col3, col4)</span><br><span class="line">col5 = Column(<span class="string">'Course'</span>, <span class="string">'cid'</span>)</span><br><span class="line">col6 = Column(<span class="string">'Grade'</span>, <span class="string">'cid'</span>)</span><br><span class="line">con1 = AtomCond(Operators.EQ, col5, col6)</span><br><span class="line">t0 = deepcopy(Student)</span><br><span class="line">t1 = deepcopy(Grade)</span><br><span class="line">t2 = deepcopy(Course)</span><br><span class="line">t3 = mergeWithCond(<span class="string">'t3'</span>, t0, t1, con0)</span><br><span class="line">t4 = mergeWithCond(<span class="string">'t4'</span>, t3, t1, con1)</span><br><span class="line">t5 = mergeWithCond(<span class="string">'t5'</span>, t4, t2, con0)</span><br><span class="line">t6 = mergeWithCond(<span class="string">'t6'</span>, t5, t2, con1)</span><br><span class="line">t7 = selectColumns(t6, col0, col1, col2)</span><br><span class="line">print(t7)</span><br></pre></td></tr></table></figure>
<p>之后交给python的<code>exec()</code>就可以执行了。</p>
<h3 id="翻译">翻译</h3>
<h4 id="Columns-Conditions">Columns &amp; Conditions</h4>
<p>先来考虑比较容易实现的部分: <code>Column</code>和<code>Condition</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ptar.production('Column -&gt; ColumnName')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_col0</span><span class="params">(col, coln)</span>:</span></span><br><span class="line">    col.varName = getColId()</span><br><span class="line">    addStmt(<span class="string">"%s = Column(None, '%s')"</span> % (col.varName, coln.name))</span><br><span class="line"></span><br><span class="line"><span class="meta">@ptar.production('Column -&gt; TableName "." ColumnName')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_col1</span><span class="params">(col, tn, dot, cn)</span>:</span></span><br><span class="line">    col.varName = getColId()</span><br><span class="line">    addStmt(<span class="string">"%s = Column('%s', '%s')"</span> % (col.varName, tn.name, cn.name))</span><br><span class="line">    </span><br><span class="line"><span class="meta">@ptar.production('Cond -&gt; Column CMP Constant')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_cond0</span><span class="params">(cond, col, cmp_, const)</span>:</span></span><br><span class="line">    cond.varName = getConId()</span><br><span class="line">    cond.canAcc = <span class="literal">False</span></span><br><span class="line">    addStmt(<span class="string">"%s = AtomCond(Operators.%s, %s, %s)"</span> % (cond.varName, sym2op[cmp_.op], col.varName, const.val))</span><br><span class="line"></span><br><span class="line"><span class="meta">@ptar.production('Cond -&gt; Column "=" Column')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_cond1</span><span class="params">(cond, col, eq, col1)</span>:</span></span><br><span class="line">    cond.varName = getConId()</span><br><span class="line">    cond.canAcc = <span class="literal">True</span></span><br><span class="line">    addStmt(<span class="string">"%s = AtomCond(Operators.EQ, %s, %s)"</span> % (cond.varName, col.varName, col1.varName))</span><br></pre></td></tr></table></figure>
<p>通过<code>addStmt</code>，就能将这几条语句加进全局的最终结果里了。</p>
<p>这些<code>Column, Cond</code>节点，都是会包含<code>varName</code>属性的，用于确定每个节点的变量名。</p>
<p>接下来把<code>Columns</code>和<code>Cond</code>都整理进列表里:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ptar.production('Columns -&gt; Columns "," Column')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_cols0</span><span class="params">(cols, cols1, comma, col)</span>:</span></span><br><span class="line">    cols.list = cols1.list</span><br><span class="line">    cols.list.append(col.varName)</span><br><span class="line"></span><br><span class="line"><span class="meta">@ptar.production('Columns -&gt; Column')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_cols1</span><span class="params">(cols, col)</span>:</span></span><br><span class="line">    cols.list = [col.varName]</span><br><span class="line"></span><br><span class="line"><span class="meta">@ptar.production('Columns -&gt; "*"')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_cols2</span><span class="params">(cols, star)</span>:</span></span><br><span class="line">    cols.list = [<span class="string">'"*"'</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ptar.production('Expr -&gt; Expr "AND" Cond')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_ex0</span><span class="params">(expr, expr1, and_, cond)</span>:</span></span><br><span class="line">    expr.list = expr1.list</span><br><span class="line">    expr.list.append((cond.varName, cond.canAcc))</span><br><span class="line"></span><br><span class="line"><span class="meta">@ptar.production('Expr -&gt; Cond')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_ex1</span><span class="params">(expr, cond)</span>:</span></span><br><span class="line">    expr.list = [(cond.varName, cond.canAcc)]</span><br></pre></td></tr></table></figure>
<p>这里的<code>canAcc</code>属性是判断这个条件可否用于利用hash table对查询进行加速。后面会用到。</p>
<p>这样，我们应该就能够在根节点访问到这两个list:</p>
<p><img src="/2020/01/31/%E4%BB%8E%E9%9B%B6%E5%86%99%E4%B8%80%E4%B8%AA%E7%BC%96%E8%AF%91%E5%99%A8-SA,IR%E4%B8%8E%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8/PTandList.png" alt="PTandList"></p>
<h4 id="Tables">Tables</h4>
<p>由于合并表的时候需要用到<code>Expr</code>的信息，因此不能在<code>Tables</code>子树中生成合并表项的代码，而只能在根节点Query下合并。</p>
<p>为了提高查询效率，我设想的合并方式如下:</p>
<ul>
<li>
<p>条件的类型</p>
<p>存在两种条件:</p>
<ul>
<li>仅涉及单表的条件: <code>Cond -&gt; Column CMP Constant</code></li>
<li>涉及两个表的条件: <code>Cond -&gt; Column &quot;=&quot; Column</code></li>
</ul>
</li>
<li>
<p>应用条件的顺序</p>
<p>涉及单表的条件，由于会使得<strong>表项变得更少</strong>，我把它称为Filter Condition。</p>
<p>对于每个表，都先把所有Filter Condition都过一遍。这样，在合并时，无论有没有涉及两个表的条件，都可以有效减少表项，加快合并速度。</p>
<p>之后，再根据有无涉及两个表的条件，利用<code>mergeWithCond</code>或<code>mergeWithNoCond</code>合并。</p>
</li>
</ul>
<p>以<code>SELECT Student.sid, dept, score FROM Grade,Student WHERE Student.sid = Grade.sid AND cid = &quot;2019&quot;</code>为例，简单用一棵树来表示合并顺序:</p>
<p><img src="/2020/01/31/%E4%BB%8E%E9%9B%B6%E5%86%99%E4%B8%80%E4%B8%AA%E7%BC%96%E8%AF%91%E5%99%A8-SA,IR%E4%B8%8E%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8/ConditionTree.png" alt="ConditionTree"></p>
<p>再以<code>SELECT Student.sid, Course.name, score FROM Student, Grade, Course WHERE Student.sid = Grade.sid AND Course.cid = Grade.cid</code>为例:</p>
<p><img src="/2020/01/31/%E4%BB%8E%E9%9B%B6%E5%86%99%E4%B8%80%E4%B8%AA%E7%BC%96%E8%AF%91%E5%99%A8-SA,IR%E4%B8%8E%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8/ConditionTree2.png" alt="ConditionTree2"></p>
<p>根据以上考虑，不难写出如下代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ptar.production('Query -&gt; "SELECT" Columns "FROM" Tables "WHERE" Expr')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_q1</span><span class="params">(query, select, columns, f_, tables, where, expr)</span>:</span></span><br><span class="line">    hashCon = [con <span class="keyword">for</span> con <span class="keyword">in</span> expr.list <span class="keyword">if</span> con[<span class="number">1</span>]]</span><br><span class="line">    filterCon = [con <span class="keyword">for</span> con <span class="keyword">in</span> expr.list <span class="keyword">if</span> <span class="keyword">not</span> con[<span class="number">1</span>]]</span><br><span class="line">    expr.list.sort(key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    okTab = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># use filter conditions to make tables smaller first</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(tables.list)):</span><br><span class="line">        prevId = getTableId()</span><br><span class="line">        addStmt(<span class="string">"%s = deepcopy(%s)"</span> % (prevId, tables.list[i]))</span><br><span class="line">        <span class="keyword">for</span> condName, _ <span class="keyword">in</span> filterCon:</span><br><span class="line">            curId = getTableId()</span><br><span class="line">            addStmt(<span class="string">"%s = applyFilterCond('%s', %s, %s)"</span> % (curId, curId, prevId, condName))</span><br><span class="line">            prevId = curId</span><br><span class="line">        okTab.append(prevId)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># merge these small tables</span></span><br><span class="line">    <span class="keyword">if</span> len(okTab) &gt;= <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">if</span> hashCon:</span><br><span class="line">            prevId = okTab[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, len(okTab)):</span><br><span class="line">                <span class="keyword">for</span> condName, _ <span class="keyword">in</span> hashCon:</span><br><span class="line">                    curId = getTableId()</span><br><span class="line">                    addStmt(<span class="string">"%s = mergeWithCond('%s', %s, %s, %s)"</span> % (curId, curId, prevId, okTab[i], condName))</span><br><span class="line">                    prevId = curId</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            prevId = okTab[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, len(okTab)):</span><br><span class="line">                curId = getTableId()</span><br><span class="line">                addStmt(<span class="string">"%s = mergeWithNoCond('%s', %s, %s)"</span> % (curId, curId, prevId, okTab[i]))</span><br><span class="line">                prevId = curId</span><br><span class="line"></span><br><span class="line">    resultTableId = getTableId()</span><br><span class="line">    addStmt(<span class="string">"%s = selectColumns(%s, %s)"</span> % (resultTableId, prevId, <span class="string">", "</span>.join(columns.list)))</span><br><span class="line">    addStmt(<span class="string">"print(%s)"</span> % resultTableId)</span><br></pre></td></tr></table></figure>
<p>而对于没有<code>where</code>的查询，就非常简单了:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ptar.production('Query -&gt; "SELECT" Columns "FROM" Tables')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_q0</span><span class="params">(query, select, columns, f_, tables)</span>:</span></span><br><span class="line">    <span class="comment"># print(columns.list, tables.list)</span></span><br><span class="line">    prevId = getTableId()</span><br><span class="line">    addStmt(<span class="string">"%s = deepcopy(%s)"</span> % (prevId, tables.list[<span class="number">0</span>]))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, len(tables.list)):</span><br><span class="line">        curId = getTableId()</span><br><span class="line">        addStmt(<span class="string">"%s = mergeWithNoCond('%s', %s, %s)"</span> % (curId, curId, prevId, tables.list[i]))</span><br><span class="line">        prevId = curId</span><br><span class="line">    resultTableId = getTableId()</span><br><span class="line">    addStmt(<span class="string">"%s = selectColumns(%s, %s)"</span> % (resultTableId, prevId, <span class="string">", "</span>.join(columns.list)))</span><br><span class="line">    addStmt(<span class="string">"print(%s)"</span> % resultTableId)</span><br></pre></td></tr></table></figure>
<p>还有很多不是特别重要的翻译规则，因而在此略去。</p>
<h3 id="成果">成果</h3>
<p>对于一个引擎来说，正确性和效率都是非常重要的。</p>
<p>这种实现题通常都很难确认数据的准确性。好在这题有CCSP提供的数据与正解，因此我写了个简易Checker:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> system</span><br><span class="line"><span class="keyword">from</span> glob <span class="keyword">import</span> glob</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> stdout</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> filename <span class="keyword">in</span> glob(<span class="string">"SQLData/*.in"</span>):</span><br><span class="line">    cmd = <span class="string">"python sql.py &lt; %s.in &gt; %s.out"</span> % (filename[:<span class="number">-3</span>], filename[:<span class="number">-3</span>])</span><br><span class="line">    print(<span class="string">"executing '"</span> + cmd + <span class="string">"' ..."</span>, end=<span class="string">""</span>)</span><br><span class="line">    stdout.flush()</span><br><span class="line">    time0 = time()</span><br><span class="line">    system(cmd)</span><br><span class="line">    print(<span class="string">" done, time cost: %.5fs. Checking output and answer... "</span> % (time() - time0), end=<span class="string">""</span>)</span><br><span class="line">    stdout.flush()</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"%s.out"</span> % filename[:<span class="number">-3</span>], <span class="string">"r"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        out = f.read()</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"%s.ans"</span> % filename[:<span class="number">-3</span>], <span class="string">"r"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        ans = f.read()</span><br><span class="line">    <span class="keyword">if</span> out == ans:</span><br><span class="line">        print(<span class="string">"Accepted"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"Wrong Answer"</span>)</span><br></pre></td></tr></table></figure>
<p>然后跑一下看看结果…</p>
<p><img src="/2020/01/31/%E4%BB%8E%E9%9B%B6%E5%86%99%E4%B8%80%E4%B8%AA%E7%BC%96%E8%AF%91%E5%99%A8-SA,IR%E4%B8%8E%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8/SQLFinish2.png" alt="SQLFinish2"></p>
<p>尽管写的是Accepted，不过那也只是答案正确而已。看这个接近3秒的查询时间，说实话还是有点担心TLE的…</p>
<p>然后稍微美化一下输出，顺便把分析树也打印出来，大致就会得到如下输出:</p>
<p><img src="/2020/01/31/%E4%BB%8E%E9%9B%B6%E5%86%99%E4%B8%80%E4%B8%AA%E7%BC%96%E8%AF%91%E5%99%A8-SA,IR%E4%B8%8E%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8/SQLFinish.png" alt="SQLFinish"></p>
<h3 id="能不能再牛逼一点">能不能再牛逼一点?</h3>
<p>其实写这道题的时候，我就有种<em>CFG简化到了这种地步，似乎完全没有体现出递归文法的优势</em>的想法。</p>
<p>其实稍微看看以前上数据库课的时候的代码就能发现，其实还有<code>Column -&gt; &quot;(&quot; Query &quot;)&quot; ColumnName</code>这种语法:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> s.ID, s.name, s.dept_name, (</span><br><span class="line">	<span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">case</span> <span class="keyword">when</span> takes.grade = <span class="string">'F'</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="literal">null</span> <span class="keyword">end</span>)</span><br><span class="line">	<span class="keyword">from</span> student <span class="keyword">left</span> <span class="keyword">join</span> takes <span class="keyword">on</span> student.ID = takes.ID</span><br><span class="line">	<span class="keyword">where</span> s.ID = student.ID</span><br><span class="line">) fail, (</span><br><span class="line">	<span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">case</span> <span class="keyword">when</span> takes.grade = <span class="string">'F'</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="literal">null</span> <span class="keyword">end</span>)</span><br><span class="line">	<span class="keyword">from</span> student <span class="keyword">left</span> <span class="keyword">join</span> takes <span class="keyword">on</span> student.ID = takes.ID</span><br><span class="line">	<span class="keyword">where</span> s.dept_name = student.dept_name</span><br><span class="line">) all_fail</span><br><span class="line"><span class="keyword">from</span> student <span class="keyword">as</span> s</span><br></pre></td></tr></table></figure>
<p>同样的，<code>where</code>语句中也可以包含<code>Query</code>:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>, <span class="keyword">name</span></span><br><span class="line"><span class="keyword">from</span> student</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span> (</span><br><span class="line">    <span class="keyword">select</span> takes.id</span><br><span class="line">    <span class="keyword">from</span> takes</span><br><span class="line">    <span class="keyword">where</span> takes.id = student.id</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>所以也可以再补上一个<code>Expr -&gt; Expr &quot;exists&quot; &quot;(&quot; Query &quot;)&quot; | Expr &quot;not&quot; &quot;exists&quot; &quot;(&quot; Query &quot;)&quot;</code>。</p>
<p>还有<code>join | left join | full outer join ...</code>、<code>with</code>、聚合函数、<code>group by</code>、<code>order by</code>:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> full_st(<span class="keyword">ID</span>) <span class="keyword">as</span> (</span><br><span class="line">	<span class="keyword">select</span> s.id</span><br><span class="line">	<span class="keyword">from</span> student <span class="keyword">as</span> s</span><br><span class="line">	<span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span> (</span><br><span class="line">		<span class="keyword">select</span> course_id</span><br><span class="line">		<span class="keyword">from</span> teaches <span class="keyword">left</span> <span class="keyword">join</span> instructor <span class="keyword">on</span> teaches.ID = instructor.ID</span><br><span class="line">		<span class="keyword">where</span> instructor.dept_name = <span class="string">'丐帮'</span></span><br><span class="line">		<span class="keyword">except</span></span><br><span class="line">		<span class="keyword">select</span> takes.course_id</span><br><span class="line">		<span class="keyword">from</span> takes</span><br><span class="line">		<span class="keyword">where</span> s.ID = takes.ID</span><br><span class="line">	)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> student.ID, student.name, <span class="keyword">count</span>(*) <span class="string">'Course Count'</span></span><br><span class="line"><span class="keyword">from</span> full_st <span class="keyword">left</span> <span class="keyword">join</span> student    <span class="keyword">on</span> full_st.ID != student.ID</span><br><span class="line">			 <span class="keyword">left</span> <span class="keyword">join</span> takes      <span class="keyword">on</span> student.ID = takes.ID</span><br><span class="line">			 <span class="keyword">left</span> <span class="keyword">join</span> teaches    <span class="keyword">on</span> takes.course_id = teaches.course_id </span><br><span class="line">							     <span class="keyword">and</span> takes.year      = teaches.year</span><br><span class="line">							     <span class="keyword">and</span> takes.semester  = teaches.semester</span><br><span class="line">							     <span class="keyword">and</span> takes.sec_id    = teaches.sec_id</span><br><span class="line">			 <span class="keyword">left</span> <span class="keyword">join</span> instructor <span class="keyword">on</span> instructor.ID = teaches.ID</span><br><span class="line"><span class="keyword">where</span> takes.grade <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">and</span> instructor.dept_name = <span class="string">'丐帮'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> student.ID, student.name</span><br></pre></td></tr></table></figure>
<p>除此之外还要考虑<code>insert, update</code>之类的语句。</p>
<p>尽管group by，聚合函数，join等都想好了要怎么实现，果然还是更想把接下来的simpleJava的编译器写出来。作为利用Parse Tree来生成线性IR的练习，我想应该到这里也就差不多了吧。</p>
<p>而且，现在的实现更像是小打小闹一样，几乎没有任何可扩展性。要加入新功能，实在是麻烦。</p>
<p>考虑在未来重写一个数据库系统吧。</p>
<h2 id="Appendix-A">Appendix A</h2>
<h3 id="TreeNode-format"><code>TreeNode.format()</code></h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">format</span><span class="params">(self)</span> -&gt; (list, int, int):</span></span><br><span class="line">    <span class="comment"># [str, str, str, ...], width, height</span></span><br><span class="line">    val = self.getContent()</span><br><span class="line">    <span class="keyword">if</span> len(self.getChilds()) &gt;= <span class="number">2</span>:</span><br><span class="line">        c, w, h = [], [], <span class="number">0</span></span><br><span class="line">        firstLLen, lastRLen = <span class="number">-1</span>, <span class="number">-1</span></span><br><span class="line">        secondLine = []</span><br><span class="line">        <span class="keyword">for</span> child <span class="keyword">in</span> self.getChilds():</span><br><span class="line">            tc, tw, th, lLen = child.format()</span><br><span class="line">            c.append(tc)</span><br><span class="line">            w.append(tw)</span><br><span class="line">            rLen = tw - lLen - <span class="number">1</span></span><br><span class="line">            secondLine.append(<span class="string">"%s|%s"</span> % (<span class="string">" "</span> * lLen, <span class="string">" "</span> * rLen))</span><br><span class="line">            <span class="keyword">if</span> firstLLen == <span class="number">-1</span>:</span><br><span class="line">                firstLLen = lLen</span><br><span class="line">            lastRLen = rLen</span><br><span class="line">            h = max(h, th)</span><br><span class="line">        secondLine = (<span class="string">" "</span> * self.SPLIT_LENGTH).join(secondLine)</span><br><span class="line">        wa = sum(w) + (len(self.getChilds()) - <span class="number">1</span>) * self.SPLIT_LENGTH</span><br><span class="line">        rc = [list() <span class="keyword">for</span> _ <span class="keyword">in</span> range(h)]  <span class="comment"># result c</span></span><br><span class="line">        leftMargin = rightMargin = <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> wa &lt; len(val):</span><br><span class="line">            totalMargin = len(val) - wa</span><br><span class="line">            leftMargin = totalMargin &gt;&gt; <span class="number">1</span></span><br><span class="line">            rightMargin = totalMargin - leftMargin</span><br><span class="line">            secondLine = <span class="string">" "</span> * leftMargin + secondLine + <span class="string">" "</span> * rightMargin</span><br><span class="line">            wa = len(val)</span><br><span class="line">            firstLLen += leftMargin</span><br><span class="line">            lastRLen += rightMargin</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> range(h):</span><br><span class="line">            <span class="keyword">for</span> i, cc <span class="keyword">in</span> enumerate(c):</span><br><span class="line">                <span class="keyword">if</span> line &lt; len(cc):</span><br><span class="line">                    rc[line].append(cc[line])</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    rc[line].append(<span class="string">" "</span> * w[i])</span><br><span class="line">            rc[line] = <span class="string">" "</span> * leftMargin + (<span class="string">" "</span> * self.SPLIT_LENGTH).join(rc[line]) + <span class="string">" "</span> * rightMargin</span><br><span class="line">        tot_slash = (wa - firstLLen - lastRLen)</span><br><span class="line">        lts = (tot_slash - <span class="number">1</span>) &gt;&gt; <span class="number">1</span></span><br><span class="line">        rts = tot_slash - lts - <span class="number">1</span></span><br><span class="line">        firstLine = <span class="string">"%s%s|%s%s"</span> % (<span class="string">" "</span> * firstLLen, <span class="string">"_"</span> * lts, <span class="string">"_"</span> * rts, <span class="string">" "</span> * lastRLen)</span><br><span class="line">        ret3 = firstLLen + lts</span><br><span class="line">        <span class="keyword">if</span> len(val) &gt; tot_slash:</span><br><span class="line">            morePart = len(val) - tot_slash</span><br><span class="line">            lmp = morePart &gt;&gt; <span class="number">1</span></span><br><span class="line">            rmp = morePart - lmp</span><br><span class="line">            firstLLen -= lmp</span><br><span class="line">            lastRLen -= rmp</span><br><span class="line">            <span class="keyword">if</span> firstLLen &lt; <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> range(h):</span><br><span class="line">                    rc[i] = <span class="string">" "</span> * (-firstLLen) + rc[i]</span><br><span class="line">                secondLine = <span class="string">" "</span> * (-firstLLen) + secondLine</span><br><span class="line">                firstLine = <span class="string">" "</span> * (-firstLLen) + firstLine</span><br><span class="line">                wa -= firstLLen</span><br><span class="line">                firstLLen = <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> lastRLen &lt; <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> range(h):</span><br><span class="line">                    rc[i] = rc[i] + <span class="string">" "</span> * (-lastRLen)</span><br><span class="line">                secondLine += <span class="string">" "</span> * (-lastRLen)</span><br><span class="line">                firstLine += <span class="string">" "</span> * (-lastRLen)</span><br><span class="line">                wa -= lastRLen</span><br><span class="line">                lastRLen = <span class="number">0</span></span><br><span class="line">            zeroLine = <span class="string">"%s%s%s"</span> % (<span class="string">" "</span> * firstLLen, val, <span class="string">" "</span> * lastRLen)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            ltsz = (tot_slash - len(val)) &gt;&gt; <span class="number">1</span></span><br><span class="line">            rtsz = tot_slash - ltsz - len(val)</span><br><span class="line">            firstLLen += ltsz</span><br><span class="line">            zeroLine = <span class="string">"%s%s%s"</span> % (<span class="string">" "</span> * firstLLen, val, <span class="string">" "</span> * (rtsz + lastRLen))</span><br><span class="line">        result = [zeroLine, firstLine, secondLine]</span><br><span class="line">        result.extend(rc)</span><br><span class="line">        <span class="comment"># print("==%d, %d==\n%s" % (wa, h + 3, '\n'.join(result)))</span></span><br><span class="line">        <span class="keyword">return</span> result, wa, h + <span class="number">3</span>, ret3</span><br><span class="line">    <span class="keyword">elif</span> len(self.getChilds()) == <span class="number">1</span>:</span><br><span class="line">        c, w, h, firstLLen = self.getChilds()[<span class="number">0</span>].format()</span><br><span class="line">        lastRLen = w - firstLLen</span><br><span class="line">        <span class="keyword">if</span> w &lt; len(val):</span><br><span class="line">            totalMargin = len(val) - w</span><br><span class="line">            leftMargin = totalMargin &gt;&gt; <span class="number">1</span></span><br><span class="line">            rightMargin = totalMargin - leftMargin</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(h):</span><br><span class="line">                c[i] = <span class="string">"%s%s%s"</span> % (<span class="string">" "</span> * leftMargin, c[i], <span class="string">" "</span> * rightMargin)</span><br><span class="line">            w = len(val)</span><br><span class="line">            firstLLen += leftMargin</span><br><span class="line">            lastRLen += rightMargin</span><br><span class="line">        lc = len(val) &gt;&gt; <span class="number">1</span></span><br><span class="line">        rc = len(val) - lc</span><br><span class="line">        <span class="keyword">if</span> firstLLen &lt; lc:</span><br><span class="line">            lmp = lc - firstLLen</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(h):</span><br><span class="line">                c[i] = <span class="string">" "</span> * lmp + c[i]</span><br><span class="line">            w += lmp</span><br><span class="line">            firstLLen = lc</span><br><span class="line">        <span class="keyword">if</span> lastRLen &lt; rc:</span><br><span class="line">            rmp = rc - lastRLen</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(h):</span><br><span class="line">                c[i] = c[i] + <span class="string">" "</span> * rmp</span><br><span class="line">            w += rmp</span><br><span class="line">            lastRLen = rc</span><br><span class="line">        zeroLine = <span class="string">"%s%s%s"</span> % (<span class="string">" "</span> * (firstLLen - lc), val, <span class="string">" "</span> * (lastRLen - rc))</span><br><span class="line">        firstLine = <span class="string">"%s|%s"</span> % (<span class="string">" "</span> * firstLLen, <span class="string">" "</span> * (lastRLen - <span class="number">1</span>))</span><br><span class="line">        result = [zeroLine, firstLine]</span><br><span class="line">        result.extend(c)</span><br><span class="line">        <span class="comment"># print("==%d, %d==\n%s" % (w, h + 2, '\n'.join(result)))</span></span><br><span class="line">        <span class="keyword">return</span> result, w, h + <span class="number">2</span>, firstLLen</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> [val], len(val), <span class="number">1</span>, len(val) &gt;&gt; <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h2 id="References">References</h2>
<ul>
<li><a href="http://gcc.gnu.org/onlinedocs/gccint/SSA.html" target="_blank" rel="noopener">http://gcc.gnu.org/onlinedocs/gccint/SSA.html</a></li>
<li><a href="https://cs.lmu.edu/~ray/notes/ir/" target="_blank" rel="noopener">https://cs.lmu.edu/~ray/notes/ir/</a></li>
</ul>

        </div>

        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/python/"># python</a>
                    
                        <a href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/"># 编译原理</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2020/02/13/%E4%BB%8E%E9%9B%B6%E5%86%99%E4%B8%80%E4%B8%AA%E7%BC%96%E8%AF%91%E5%99%A8-simpleJava-Compiler/">从零写一个编译器 - simpleJava Compiler</a>
            
            
            <a class="next" rel="next" href="/2019/12/15/%E4%BB%8E%E9%9B%B6%E5%86%99%E4%B8%80%E4%B8%AA%E7%BC%96%E8%AF%91%E5%99%A8-Lexer%E4%B8%8EParser/">从零写一个编译器 - Lexer与Parser</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© medioqrity | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>
