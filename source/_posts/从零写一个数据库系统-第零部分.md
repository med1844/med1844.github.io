---
title: 从零写一个数据库系统（一）
date: 2020-03-04 19:15:28
tags: 数据库
category: 造轮子 
hidden: true
---

我所在的大学里总是只教一些特别浅显的东西。比方说，怎么在`select`里面套`select`里面套`select`，或者是怎么把聚合函数用出花来。之后再摆出十万甚至九万道概念题，考你Database和Database system的区别，或者ACID每个字母代表的意思。

明白基础的概念固然重要，掌握基本的使用方法也无可厚非。但是，这些东西该怎么实现呢?

ないです~

当然我也可以理解，毕竟并不是每个进到这所学校的人都有着写数据库系统的决心与能力。而教授们的水平可能也并不足以让他们写这么个东西出来。就算他们有这样的能力，恐怕有这意愿的人数也不足以开课，甚至可能只有我一人。

就在不久前，我的老师告诉我，我是她教了这么多年编译原理以来第一个写出编译器的人。这句话虽然听着好听，仔细想一想，多少也感到可悲。而这编译器竟又如此简陋，到了我都不好意思称它为编译器的程度。除了前端外，全是闭门造车，质量也可想而知。如此一来，讽刺的纯度也又大大地提升了。

*这里插一嘴，我准备重写编译器，用c/c++。在那之前可能会先去学习LLVM，学习已有的经验。*

不论讲什么东西，都只是浅尝辄止，而并不说明实现。就像是所有东西只要有了理论就有高效可靠的实现一样，仿佛总是可以心安理得地用"总会有人把轮子造出来的"这样的心态，永远等着从别人那里拿来轮子。而不用去做这种苦力活的自己，也仿佛晋升贵族，不用再和造轮子的乡巴佬们为伍了。反过来，还可以啐一口唾沫，咒骂这些造轮子的苦力们非得把简简单单的读写数据这么件事做得这么麻烦。

若是这样的话，那我们和培训机构出来的家伙又有什么区别呢?

---

除了对实现的好奇之外，还有一个原因促使我开始写这个东西:

**我从来没有用C / C++写过正经项目。**

尽管有大一小学期乱搞的C++ & Qt计算器，说实话学完编译回头一看，还真是naïve。而其他语言，java上手就是minecrash，外加JavaEE几个小项目，底子虽然不稳，总归也算入了门了。python的话，之前闭门造车的[编译器](/2019/12/15/从零写一个编译器-Lexer与Parser/)、最近才写好的[The Blockheads存档修改工具](/2020/03/02/The-Blockheads存档修改工具开发记录/)，虽然硬要说的话也不怎么正经，不过也总比C++的情况要不知道高到哪里去了。

---

*这篇文章的知识来自于 **[CMU 15-445/645: Intro to Database Systems](https://www.youtube.com/playlist?list=PLSE8ODhjZXjbohkNBWQs_otTrBTrjyohi)** ，可能会在说明实现时涉及一部分课上的内容，但绝非笔记。*

---

## Storage

作为一个数据库，坠坠重要的事情当然就是存储数据啦！

数据库显然会把数据存储在non-volatile的存储介质上，否则就会因为断电而损失数据。这样的介质通常就是SSD或者HDD。

数据库会按照page来存储数据。当需要用到数据的时候，会先把相应的页读到RAM中的Buffer Pool中，进而再执行各种关系代数的运算。而读到内存中的页也会就一直放在那，直到出现页置换之类的情况才被换下来，与[操作系统](/2019/06/21/操作系统总结/#页置换算法)很相似。

事实上，Buffer Pool就是手动实现一个缓存。这样，就势必要避开操作系统提供的cache服务。这么做的目的是因为OS提供的缓存机制必须对任何应用都有效。而拥有更多上下文信息的数据库系统，显然比操作系统更清楚怎样使用cache能够减少IO次数。

所以，在读文件时，需要采用[**`O_DIRECT`**](https://linux.die.net/man/2/open)来避开OS的缓存。